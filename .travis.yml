language: java
jdk:
- openjdk8

services:
- docker

cache:
  directories:
  - "$HOME/.m2"

env:
  global:
  - GRADLE_VERSION=5.6.2
  - BITCOIND_CONNECTOR_TAG=v0.16.0
  - BITCOINJ_TAG=0.16.7-LIB
  - LATEST_VERSION=$(git log -n 1 --pretty=format:"%h")

install:
- sudo apt-get -qq update
- sudo apt-get install -y protobuf-compiler

before_script:
- gradle -version
- gradle wrapper --gradle-version=$GRADLE_VERSION
- "./scripts/install-deps.sh"

script:
- ls -l "xyz.balzaclang.balzac" | grep -e "xyz\.balzaclang\.balzac\.lib.*-bundled\.jar"
- mvn -f xyz.balzaclang.balzac.parent/ -U clean install

after_success:
- mvn -f xyz.balzaclang.balzac.lib/ jacoco:report coveralls:report -DrepoToken=$REPO_TOKEN
- docker build -f docker/Dockerfile-slim -t balzaclang/balzac:latest -t balzaclang/balzac:${LATEST_VERSION} .
- docker build -f docker/Dockerfile-slim.arm32v7 -t balzaclang/balzac-arm32v7:latest -t balzaclang/balzac-arm32v7:${LATEST_VERSION} .
- docker build -f docker/Dockerfile-slim.arm64v8 -t balzaclang/balzac-arm64v8:latest -t balzaclang/balzac-arm64v8:${LATEST_VERSION} .

notifications:
  email:
    recipients:
    - atzeinicola@gmail.com
    on_success: change
    on_failure: always

deploy:
- provider: releases
  prerelease: true
  api_key:
    secure: PG0ArEC5r0HdHiLWNB5sDYqgNqtCxjzwKkQY509QKLKq5+omeoWTR91pX0sJb3GedA9dSJcdu9uIbGiByO/DXf20lV5PHXdxjzqdMFxwMtMuv2zGXnNAMUwZpTMrc1Pu2LaPxdcLiA3mt/gb3s6SwngwK3lf37M6t2ngbjEzy/EkW42RpwhJKfezrls5Fn81sMqJL8qRqpX8xuP/xMbkFuckdKGYACg5+ut+gLaM6SclQ3EtX6dFExNqKr8MAplhxZ/0KU7bWoqQdGIRKywvIjm6xtmGELaaj8ehYO6jkuOgE2UDmdE7Fgj2rnm1SZ1XhAZAT+TdVlMbdTXlvp/2I39MBcWocyKIfqvHS2eoBUn+Vt9DpCOgLTyWpuM/QDa/waaPciNnGMhX1lmNr7oRtHvlBioSXu4b5dhO0EE375a2vNkRH0/x+12lY+1S3PFxYfV/fL7BZSaZSiw0HzSKbqev6rdIaXMTWeZuXAxZVyL4XJpUzRxi9gdy9if1COZK9Nw5ZL8u8iDara617VKx5Hmm0ol0i44BMwJJG6ZeD1SkORwBhIwwHPdxefB8KkEdZ0y+686BvVkwTL/1vTLjwiIwYkuZ+PVuwfXuV8kOabFRYK9HKOv/DORXKTJQBmu9lQG+bZ5dEUB/cm7XAt2FnLbn/B7JwlTLpqwxEKLbpKQ=
  file_glob: true
  file: xyz.balzaclang.balzac.web/target/balzac*.war
  on:
    tags: true
    jdk: openjdk8
    repo: balzac-lang/balzac
- provider: script
  script: bash scripts/docker_push.sh
  on:
    tags: true
    jdk: openjdk8
    repo: balzac-lang/balzac


